name: Deploy to TestFlight

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-submit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - run: npm ci

      - name: Generate changelog
        id: changelog
        run: |
          # Find the last build tag
          LAST_TAG=$(git tag -l 'build/v*' --sort=-version:refname | head -n1)

          if [ -z "$LAST_TAG" ]; then
            COMMITS=$(git log --pretty=format:"%s" origin/main)
          else
            COMMITS=$(git log --pretty=format:"%s" ${LAST_TAG}..HEAD)
          fi

          # Build changelog from PR merge commit titles
          CHANGELOG=""
          while IFS= read -r commit; do
            if [[ $commit =~ ^.*\(#[0-9]+\)$ ]]; then
              TITLE=$(echo "$commit" | sed 's/ (#[0-9]\+)$//')
              if [ -n "$CHANGELOG" ]; then
                CHANGELOG="${CHANGELOG}\n- ${TITLE}"
              else
                CHANGELOG="- ${TITLE}"
              fi
            fi
          done <<< "$COMMITS"

          if [ -z "$CHANGELOG" ]; then
            CHANGELOG="Minor improvements and bug fixes"
          fi

          CHANGELOG=$(echo -e "$CHANGELOG" | head -c 4000)

          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo -e "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Set version from tag
        if: startsWith(github.ref, 'refs/tags/v')
        run: echo "APP_VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_ENV

      - name: Build iOS and submit to TestFlight
        env:
          SENTRY_ALLOW_FAILURE: 'true'
        run: eas build --platform ios --profile production --non-interactive --auto-submit

      - name: Tag build with changelog
        if: success()
        run: |
          LAST_TAG=$(git tag -l 'build/v*' --sort=-version:refname | head -n1)
          if [ -z "$LAST_TAG" ]; then
            BUILD_NUM=1
          else
            BUILD_NUM=$(($(echo $LAST_TAG | sed 's/build\/v//') + 1))
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "build/v${BUILD_NUM}" -m "${{ steps.changelog.outputs.changelog }}"
          git push origin "build/v${BUILD_NUM}"

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          LAST_TAG=$(git tag -l 'build/v*' --sort=-version:refname | head -n1)
          gh release create "$LAST_TAG" \
            --title "Build ${LAST_TAG#build/}" \
            --notes "${{ steps.changelog.outputs.changelog }}"
