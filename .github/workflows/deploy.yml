name: Deploy to TestFlight

on:
  push:
    branches: [main]

jobs:
  build-and-submit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - run: npm ci

      - name: Generate changelog
        id: changelog
        run: |
          # Find the last build tag
          LAST_TAG=$(git tag -l 'build/v*' --sort=-version:refname | head -n1)

          if [ -z "$LAST_TAG" ]; then
            # No previous build tag, get all commits
            COMMITS=$(git log --pretty=format:"%s" origin/main)
          else
            # Get commits since last tag
            COMMITS=$(git log --pretty=format:"%s" ${LAST_TAG}..origin/main)
          fi

          # Build changelog from PR merge commit titles
          CHANGELOG=""
          while IFS= read -r commit; do
            # Match PR merge commits (format: "Title (#123)")
            if [[ $commit =~ ^.*\(#[0-9]+\)$ ]]; then
              # Extract title without PR number
              TITLE=$(echo "$commit" | sed 's/ (#[0-9]\+)$//')
              if [ -n "$CHANGELOG" ]; then
                CHANGELOG="${CHANGELOG}\n- ${TITLE}"
              else
                CHANGELOG="- ${TITLE}"
              fi
            fi
          done <<< "$COMMITS"

          # Fallback if no PRs found
          if [ -z "$CHANGELOG" ]; then
            CHANGELOG="Minor improvements and bug fixes"
          fi

          # Truncate to 4000 chars (Apple's limit)
          CHANGELOG=$(echo -e "$CHANGELOG" | head -c 4000)

          # Export for next step (handle multiline)
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo -e "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Inject changelog into eas.json
        run: |
          # Use jq to add changelog to submit.production.ios
          jq --arg cl "${{ steps.changelog.outputs.changelog }}" '.submit.production.ios.changelogs = {"en-US": $cl}' eas.json > eas.json.tmp
          mv eas.json.tmp eas.json

      - name: Build iOS and submit to TestFlight
        run: eas build --platform ios --profile production --non-interactive --auto-submit

      - name: Tag build
        if: success()
        run: |
          # Get the next build number
          LAST_TAG=$(git tag -l 'build/v*' --sort=-version:refname | head -n1)
          if [ -z "$LAST_TAG" ]; then
            BUILD_NUM=1
          else
            BUILD_NUM=$(($(echo $LAST_TAG | sed 's/build\/v//') + 1))
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag "build/v${BUILD_NUM}"
          git push origin "build/v${BUILD_NUM}"
